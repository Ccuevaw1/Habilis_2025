<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Ingeniería</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF (necesaria para html2pdf) -->
  <!-- html2pdf CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
<header class="encabezado">
  <div class="barra-navegacion">
    <img src="images/logo.png" alt="Logo Habilits" class="logo" />
    <div class="barra-controles">
      <div class="select-wrapper">
        <select class="select-carrera" id="select-carrera">
          <option selected disabled>Ingeniería</option>
          <option>Ingeniería Industrial</option>
          <option>Ingeniería de Sistemas</option>
          <option>Ingeniería Civil</option>
          <option>Ingeniería de Minas</option>
          <option>Ingeniería Agrónoma</option>
          <option>Ingeniería Ambiental</option>
        </select>
      </div>
      <input type="file" id="inputCsv" accept=".csv" style="display: none;" />
      <button class="btn-subir" id="btnUpload">Subir CSV</button>
      <input type="file" id="inputManualCsv" accept=".csv" style="display: none;" />
      <button class="btn-verificar" id="btnVerificar">Verificar Precisión</button>
      <button class="btn-exportar" id="btnExportar">EXPORTAR</button>
    </div>
  </div>
</header>

<section id="contenedor-pdf">
  <div class="franja-blanca">
    <h1 class="titulo-principal" id="titulo-carrera">INGENIERÍA DE SISTEMAS</h1>
  </div>

  <main class="dashboard-grid">
    <!--Gráfico Habilidades Técnicas -->
    <div class="grafico-card" id="grafico-tecnicas-container" style="grid-column: 1; grid-row: 1;">
      <h3>Habilidades Técnicas</h3>
      <canvas id="graficoTecnicas"></canvas>
    </div>

    <!--Gráfico Habilidades Blandas -->
    <div class="grafico-card" id="grafico-blandas-container" style="grid-column: 2; grid-row: 1;">
      <h3>Habilidades Blandas</h3>
      <canvas id="graficoBlandas"></canvas>
    </div>

    <!--Tabla Top 5 Soft Skills -->
    <div class="top-card" id="tabla-blandas-container" style="grid-column: 1; grid-row: 2;">
      <h3>Top 5 Soft Skills</h3>
      <table class="tabla-estilo" id="tabla-blandas">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Habilidad Blanda</th>
            <th>Número de Ofertas</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!--Tabla Top 5 Herramientas Tech -->
    <div class="top-card" id="tabla-tecnicas-container" style="grid-column: 2; grid-row: 2;">
      <h3>Top 5 Herramientas Tech</h3>
      <table class="tabla-estilo" id="tabla-tecnicas">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Herramienta</th>
            <th>Número de Ofertas</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Gráfico de Salarios -->
    <div class="grafico-card" id="grafico-salarios-container" style="grid-column: 1 / span 2; grid-row: 3;">
      <h3>Salarios por Puesto</h3>
      <canvas id="graficoSalarios"></canvas>
    </div>

    <div class="grafico-card" id="preparacion-datos-container" style="grid-column: 1 / span 2; grid-row: 4;">
      <h3>Resumen de Preparación de los Datos</h3>
      <ul id="resumen-preparacion">
        <li>Total de registros en el CSV original: <span id="prep-total"></span></li>
        <li>Registros eliminados: <span id="prep-eliminados"></span></li>
        <li>Registros finales utilizados: <span id="prep-finales"></span></li>
        <li>Registros con salario transformado: <span id="prep-salario-ok"></span></li>
        <li>Campos nulos rellenados: <span id="prep-rellenos"></span></li>
        <li>Columnas eliminadas: <span id="prep-columnas-eliminadas"></span></li>
        <li>¿Caracteres limpiados?: <span id="prep-limpieza"></span></li>
        <li>Habilidades detectadas: <span id="prep-habilidades"></span></li>
      </ul>
    </div>

    <div class="grafico-card" id="preview-modelado-container" style="grid-column: 1 / span 2; grid-row: 5;">
      <h3>MODELADO</h3>
      <div class="tablas-contenedor">
        <!-- Tabla sin procesar -->
        <div class="tabla-seccion">
          <h4>Datos de CSV sin procesar</h4>
          <div class="tabla-scroll-container">
            <table class="tabla-estilo tabla-crudos" id="tabla-antes"></table>
          </div>
        </div>
       
        <!-- Tabla procesada -->
        <div class="tabla-seccion">
          <h4>Datos Procesados</h4>
          <div class="tabla-scroll-container">
            <table class="tabla-estilo tabla-procesados" id="tabla-despues"></table>
          </div>
        </div>
      </div>
    </div>

    <div class="grafico-card" id="evaluacion-modelo-container" style="grid-column: 1 / span 2; grid-row: 6;">
      <h3>Evaluación del Modelo de Minería</h3>
      <ul id="resumen-evaluacion">
        <li>Precisión estimada: <span id="eval-precision"></span></li>
        <li>Recall global: <span id="eval-recall"></span></li>
        <li>Cobertura media por carrera: <span id="eval-cobertura"></span></li>
        <li>Habilidades más ruidosas: <span id="eval-ruidosas"></span></li>
      </ul>
    </div>
  </main>
</section>

<script>
const API_URL = 'https://habilis2025-production.up.railway.app/estadisticas/habilidades';
const API_SALARIOS = 'https://habilis2025-production.up.railway.app/estadisticas/salarios';
const selectCarrera = document.getElementById('select-carrera');
const tituloCarrera = document.getElementById('titulo-carrera');

const graficoTecnicas = new Chart(document.getElementById('graficoTecnicas'), {
  type: 'bar',
  data: { labels: [], datasets: [{ label: 'Frecuencia', data: [], backgroundColor: '#4e73df' }] },
  options: { indexAxis: 'y' }
});

const graficoBlandas = new Chart(document.getElementById('graficoBlandas'), {
  type: 'bar',
  data: { labels: [], datasets: [{ label: 'Frecuencia', data: [], backgroundColor: '#1cc88a' }] },
  options: { indexAxis: 'y' }
});

selectCarrera.addEventListener('change', () => {
  const inicioTiempo = Date.now(); // tiempo seleccionar carrera en segundos
  const carrera = selectCarrera.value;
  tituloCarrera.textContent = carrera.toUpperCase();
  fetch(`${API_URL}?carrera=${encodeURIComponent(carrera)}`)
    .then(res => res.json())
    .then(data => {
      const topTecnicas = data.habilidades_tecnicas.slice(0, 5);
      const topBlandas = data.habilidades_blandas.slice(0, 5);

      graficoTecnicas.data.labels = topTecnicas.map(h => h.nombre);
      graficoTecnicas.data.datasets[0].data = topTecnicas.map(h => h.frecuencia);
      graficoTecnicas.update();

      graficoBlandas.data.labels = topBlandas.map(h => h.nombre);
      graficoBlandas.data.datasets[0].data = topBlandas.map(h => h.frecuencia);
      graficoBlandas.update();

      document.querySelector('#tabla-blandas tbody').innerHTML = topBlandas.map((h, i) =>
        `<tr><td>${i+1}</td><td>${h.nombre}</td><td>${h.frecuencia}</td></tr>`).join('');

      document.querySelector('#tabla-tecnicas tbody').innerHTML = topTecnicas.map((h, i) =>
        `<tr><td>${i+1}</td><td>${h.nombre}</td><td>${h.frecuencia}</td></tr>`).join('');
    });

  // Nuevo fetch para los salarios
  fetch(`${API_SALARIOS}?carrera=${encodeURIComponent(carrera)}`)
  .then(res => res.json())
  .then(data => {
    const salarios = data.salarios || [];
    const puestos = salarios.map(s => s.puesto.length > 40 ? s.puesto.slice(0, 37) + '...' : s.puesto);
    const valores = salarios.map(s => s.salario);

    if (window.graficoSalariosInstance) {
      window.graficoSalariosInstance.destroy();
    }

    const ctx = document.getElementById('graficoSalarios').getContext('2d');
    window.graficoSalariosInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: puestos,
        datasets: [{
          label: 'Salario (S/)',
          data: valores,
          backgroundColor: 'rgba(72, 191, 145, 0.8)', // tono verde profesional
          borderColor: '#48bf91',
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y', // BARRAS HORIZONTALES
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => `S/ ${ctx.raw.toLocaleString()}`
            }
          },
          title: {
            display: false
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              callback: value => `S/ ${value.toLocaleString()}`
            },
            title: {
              display: true,
              text: "Salario en soles (S/)",
              color: "#333",
              font: { size: 14, weight: "bold" }
            }
          },
          y: {
            ticks: {
              color: "#333",
              font: { size: 12 }
            }
          }
        }
      }
    });
    const finTiempo = Date.now();
    fetch(`https://habilis2025-production.up.railway.app/tiempo-carga/?carrera=${encodeURIComponent(carrera)}&inicio=${inicioTiempo/1000}`, {
      method: "POST"
      })
    .then(res => res.json())
    .then(data => console.log(data.mensaje))
    .catch(err => console.warn("No se pudo registrar el tiempo:", err));
  });
});

// fetch("https://habilis2025-production.up.railway.app/precision-mineria/")
//   .then(res => res.json())
//   .then(data => {
//     const precisionText = data.mensaje || `Precisión del modelo de minería: ${(data.precision * 100).toFixed(2)}%`;
//     document.getElementById('precision-modelo').innerText = precisionText;
//   })
//   .catch(() => {
//     document.getElementById('precision-modelo').innerText = "No se pudo cargar la precisión del modelo.";
//   });

// Exportar sin mostrar el botón
document.getElementById('btnExportar').addEventListener('click', () => {
  const contenedor = document.getElementById('contenedor-pdf');
  const carrera = selectCarrera.value || 'ingenieria'; // fallback
  const año = new Date().getFullYear();

  // limpiar texto: minúsculas, sin tildes, guiones bajos
  const carreraFormateada = carrera
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // quita tildes
    .replace(/\s+/g, "_"); // reemplaza espacios por guiones bajos

  const nombreArchivo = `habilidades_${carreraFormateada}_${año}.pdf`;

  const opciones = {
    margin: 0.3,
    filename: nombreArchivo,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };

  html2pdf().set(opciones).from(contenedor).save();
});
//-----------------------------------------
const fileInput = document.getElementById("inputCsv");
const btnUpload = document.getElementById("btnUpload");

// Cuando haces clic en el botón, se abre el input de archivo
btnUpload.addEventListener("click", () => {
  fileInput.click();
});

// Cuando eliges un archivo, se sube automáticamente
fileInput.addEventListener("change", () => {
  const file = fileInput.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);

  fetch("https://habilis2025-production.up.railway.app/proceso-csv", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    const resumen = data.resumen;
    document.getElementById("prep-total").textContent = resumen.originales;
    document.getElementById("prep-eliminados").textContent = resumen.eliminados;
    document.getElementById("prep-finales").textContent = resumen.finales;
    document.getElementById("prep-salario-ok").textContent = resumen.transformaciones_salario;
    document.getElementById("prep-rellenos").textContent = resumen.rellenos.join(", ");
    document.getElementById("prep-columnas-eliminadas").textContent = resumen.columnas_eliminadas.join(", ");
    document.getElementById("prep-limpieza").textContent = resumen.caracteres_limpiados ? "Sí" : "No";
    document.getElementById("prep-habilidades").textContent = resumen.habilidades.join(", ");
      
    const antes = data.preview_antes;
    const despues = data.preview_despues;

    // Validación de estructura
    if (!Array.isArray(antes)) {
        console.error("Preview_antes no es un array:", antes);
    } else {
        const tablaAntes = document.getElementById("tabla-antes");
        tablaAntes.innerHTML = generarTablaHTMLCruda(antes);  // Nueva función para datos crudos
    }

    if (!Array.isArray(despues)) {
        console.error("Preview_despues no es un array:", despues);
    } else {
        const tablaDespues = document.getElementById("tabla-despues");
        tablaDespues.innerHTML = generarTablaHTML(despues);  // Función existente para datos procesados
        alert("Archivo CSV cargado correctamente!");
    }
  })
  .catch(() => alert("Error al subir el archivo, no cumple con la estructura proporcionada por Octoparse."));
});

function generarTablaHTMLCruda(data) {
  if (!data || !Array.isArray(data) || data.length === 0) {
    return '<p class="error">No hay datos crudos disponibles</p>';
  }

  try {
    // Obtener TODAS las columnas del primer registro
    const columnas = Object.keys(data[0]);
    
    // Crear tabla
    const thead = `<thead><tr>${columnas.map(col => `<th>${col}</th>`).join('')}</tr></thead>`;

      const tbody = `<tbody>${data.map(row => {
        return `<tr>${
          columnas.map(col => {
            const value = row[col];
            // Limitar el largo del texto para mejor visualización
            const text = value !== null && value !== undefined ? String(value) : '-';
            return `<td title="${text}">${text.length > 30 ? text.substring(0, 27) + '...' : text}</td>`;
          }).join('')
        }</tr>`;
      }).join('')}</tbody>`;
    return `<table class="tabla-estilo">${thead}${tbody}</table>`;
  } catch (error) {
    console.error('Error generando tabla cruda:', error);
    return `<p class="error">Error mostrando datos: ${error.message}</p>`;
  }
}

function generarTablaHTML(data) {
  if (!data || !Array.isArray(data) || data.length === 0) {
    return '<p class="error">No hay datos disponibles</p>';
  }

  try {
    // 1. Columnas base que siempre mostramos
    const columnasBase = ["career", "title", "company", "workday", "modality", "salary"];
    
    // 2. Función para formatear nombres de columnas
    const formatearNombreColumna = (col) => {
      if (columnasBase.includes(col)) return col;
      return col.replace(/^(hard|soft)_/, '')  // Quita prefijo
               .replace(/_/g, ' ')            // Reemplaza guiones bajos
               .replace(/\b\w/g, l => l.toUpperCase()); // Capitaliza
    };

    // 3. Función para truncar texto con tooltip
    const truncarTexto = (text, maxLength = 30) => {
      const str = text !== null && text !== undefined ? String(text) : '-';
      return {
        display: str.length > maxLength ? str.substring(0, maxLength-3) + '...' : str,
        full: str
      };
    };

    // 4. Encontrar columnas de habilidades con al menos un 1 (TRUE)
    const columnasHabilidadesActivas = Object.keys(data[0])
      .filter(col => (col.startsWith("hard_") || col.startsWith("soft_")) && 
             data.some(row => {
               const val = row[col];
               return val === 1 || val === true || val === "true" || val === "TRUE";
             }));

    // 5. Generar estructura de la tabla
    let html = '<table class="tabla-estilo tabla-procesada"><thead><tr>';
    
    // Encabezados para columnas base
    html += columnasBase.map(col => `<th>${formatearNombreColumna(col)}</th>`).join('');
    
    // Encabezados para habilidades activas
    html += columnasHabilidadesActivas.map(col => `<th>${formatearNombreColumna(col)}</th>`).join('');
    html += '</tr></thead><tbody>';

    // Filas de datos
    html += data.map(row => {
      let fila = '<tr>';
      
      // Columnas base con texto truncado
      fila += columnasBase.map(col => {
        const {display, full} = truncarTexto(row[col]);
        return `<td title="${escapeHtml(full)}">${escapeHtml(display)}</td>`;
      }).join('');
      
      // Columnas de habilidades (mostrar 1 o 0)
      fila += columnasHabilidadesActivas.map(col => {
        const val = row[col];
        const isActive = val === 1 || val === true || val === "true" || val === "TRUE";
        return `<td class="centrado">${isActive ? '1' : '0'}</td>`;
      }).join('');
      
      return fila + '</tr>';
    }).join('');

    return html + '</tbody></table>';
  } catch (error) {
    console.error('Error generando tabla:', error);
    return `<p class="error">Error mostrando datos: ${escapeHtml(error.message)}</p>`;
  }
}

// Función de escape HTML (añadir si no existe)
function escapeHtml(text) {
  if (text === null || text === undefined) return '';
  return text.toString()
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
} 

const inputManual = document.getElementById("inputManualCsv");
const btnVerificar = document.getElementById("btnVerificar");

btnVerificar.addEventListener("click", () => {
  inputManual.click();
});

inputManual.addEventListener("change", () => {
  const file = inputManual.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);

  fetch("https://habilis2025-production.up.railway.app/verificar-modelo/", {
    method: "POST",
    body: formData
  })
    .then(res => res.json())
    .then(data => {
      alert(data.mensaje || "Precisión calculada.");

      // Mostrar resultados directamente en la tarjeta
      document.getElementById("eval-precision").textContent = data.precision ?? "N/A";
      document.getElementById("eval-recall").textContent = data.recall ?? "N/A";
      document.getElementById("eval-cobertura").textContent = data.cobertura_media ?? "N/A";
      document.getElementById("eval-ruidosas").textContent = Object.entries(data.habilidades_ruidosas || {})
        .map(([h, v]) => `${h} (${v})`).join(", ");
    })
    .catch(() => alert("Error al verificar el modelo."));
});

// Añade este código donde manejas la verificación
async function ejecutarEvaluacionCruzada() {
  try {
    const response = await fetch(`${API_URL}/evaluacion-cruzada`);
    const data = await response.json();
    
    if (data.error) {
      alert(data.error);
      return;
    }
    
    // Actualizar la interfaz
    document.getElementById("eval-precision").textContent = 
      (data.precision_promedio * 100).toFixed(2) + "%";
    document.getElementById("eval-recall").textContent = 
      (data.recall_promedio * 100).toFixed(2) + "%";
    
    // Formatear habilidades ruidosas
    const ruidosasText = data.habilidades_ruidosas
      .map(([hab, err]) => `${hab.replace(/^(hard|soft)_/, '')} (${(err * 100).toFixed(2)}%)`)
      .join(", ");
    
    document.getElementById("eval-ruidosas").textContent = ruidosasText;
    
  } catch (error) {
    console.error("Error en evaluación cruzada:", error);
    alert("Error al realizar evaluación cruzada");
  }
}

// Llamar esta función cuando sea necesario
document.getElementById("btnEvaluarCruzada").addEventListener("click", ejecutarEvaluacionCruzada);
</script>
</body>
</html>